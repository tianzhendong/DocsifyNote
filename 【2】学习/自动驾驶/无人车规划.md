# 规划

## 概述

> 什么是规划

规划问题的本质是**搜索**问题：找出最优的结果

给出当前环境和当前状态，给出当前路径上的**最优**选择

> 规划的三个领域

* 机器人领域：生成轨迹实现目标
  * RRT，A\*, D\* ,D\* Lite
* 控制领域：动态系统理论实现目标状态
  * MPC，LQR
* 人工智能AI：生成状态和Action的一个映射

> 如何解决规划问题

将问题简化为一个简单的问题：**路径查找问题**

* 不关心速度，只关心走
* 周围固定

简而言之就是：**路径选择问题**

什么样的路径是最好的：**路径最短**

常用算法：

* 无信息搜索
  * BFS & DFS
  * Dijkstra
* **A*搜索**：知道了终点的大概位置

## 基础知识

> 特点

无人车规划相比A*：

- **部分感知**
- **动态障碍物**
- **环境复杂**

无人车规划是一个**部分感知**的问题：

- **贪心算法**：目前状态求解到最优

- **D\* star**：对部分环境信息的一个search，Apollo登月小车采用的就是，后续升级为D* Lite

**无人车规划不一定要全局最优**

其他特性：

- 处理动态环境
- 处理交通规则
- 实时性要求：人的反应时间300-500ms，需要在有限时间内找到最优解：C++

要求：

- 安全性
- 平滑性
- 达到目的地
- 输出三维轨迹
- 硬件系统：
  - 定位设备
  - 感知设备
- 软件系统：
  - 动态信息
  - 静态信息：高精度地图（HD Map），实时性的保证
- 如何设计出一个合理性的轨迹
  - 路径path
  - 速度speed

> 基本规划方法

* 基于环境建模的方法
  * RRT
  * Lattice网格
* 现代无人车规划方法
  * Darpa
  * Lattice in Frenet Frame
  * SPiral polynomial

> 模型

质点模型：

- 把物体看成一个质点
- 点和点不碰撞

刚体问题：

- 碰撞
- 单车模型
- XY Heading

> 规划限制条件

* 避免碰撞
* 边界阈值

> 离散问题怎么求解

- 离散化
- 网格化

> 传统机器人基础

PRM：

- 常用
- 连续空间离散化：随机撒点、碰到障碍物上的点删除
- 连接可行点，形成可行空间
- A*查找

RRT：

- 使用增量搜索的方式进行搜索
- 找附近可行点的最优点：cost最小、走的过程中不能有阻碍
- 撒点搜索距离不能太远，一步一步移动
- 缺点：
  - 两点之间为折线
  - 无法考虑动态障碍物

Lattice：

- 改进了RRT的折线问题
- 给出path的平滑曲线
- 网格化
  - 每个采样格中都是用曲线连接
- 问题：指数级别的搜索算法

DP动态规划：

- 减少搜索空间：复用已有的结果
- Lattice DP的平滑度问题：
  - 曲率连续
  - 曲率的导数不一定连续



QP二次规划：解决平滑问题

- 凸优化问题最优化求解

- 公式：

  $$minimize \frac{1}{2}X^{T} QX+c^{T}X$$​

  $$subject：Ex=d,Fx\leq m$$​

- 在凸优化中的图空间问题，用QP有最优解
- 其他的平滑曲线方法还有贝塞尔曲线、样条插值方法

> 刚体模型

![image-20210902233012534](https://i.loli.net/2021/09/02/Y6XQGhRDLZ2uidU.png)

前轮转向和Heading的关系：车轮沿着切线方向行驶

- 前后轮是同一个旋转中心
- 左右轮的结构相同

简化：Bicycle Model：

![image-20210902233117896](https://i.loli.net/2021/09/02/Wp9Ua2Hv5ELSkTb.png)

## 无人车规划

> 定义

从A点到B点，构建一个车辆运动轨迹

- 输入HDMap，定位和预测
- 输出：可行的轨迹，有一系列点组成
- 两个层面：导航层面，运动轨迹层面

> A*经典算法

$F(n)=G(n)+H(n)$

- Fn为当前道路的总cost
- Gn表示起始点到候选点的cost
- Hn表示候选点通过启发函数得到的目标点cost

cost大小：

- 左转cost最大，直行其次，右转最小

> 约束条件：

- 避免碰撞
- 路径点、速度平滑
- 高速转弯、掉头曲率角度
- 交通法规、人类约束俗称的规则

> Frenet坐标系（车道坐标系）

一般我们使用笛卡尔坐标系（世界坐标系）

Frenet坐标系为车道坐标系

- 以车道中心线为S，表示车走了多远
- 右手为L，表示偏离中心线多远

> Path和Speed规划

1.path规划

- 生成可行性轨迹
- 计算cost
  - 平滑性
  - 安全性
  - 道路中心偏移距离

2.选择出成本最低的一个路径规划

3.速度规划

- 每个path上选择一系列速度
- 生成速度轨迹

Path planning：

- 生成道路网格
- 随机采样（撒点）
- 每个网格选一个点，组成多条候选path

![image-20210903194435766](https://i.loli.net/2021/09/03/ZoMhjKdU3lBGLNa.png)

**speed planning**

- ST图
  - S表示在path上的额纵向距离
  - T表示运动时间

![image-20210903194620114](https://i.loli.net/2021/09/03/bVFmKwg7u6z5Usi.png)

如何规划ST轨迹：

- 连续空间离散化（网格），网格单元格内速度保持不变
- 把障碍物投影进来
  - 挡住paht轨迹的部分画进ST图
- 速度曲线不能碰撞这个区域

- 凸优化求解得到最优速度曲线
  - 限制条件：速度、安全距离、车辆动力学

![image-20210903195156488](https://i.loli.net/2021/09/03/I5FrClfdZE8mPbc.png)

![image-20210903195719571](https://i.loli.net/2021/09/03/3xgrAd8LFQ4NvZV.png)

**优化：对不平滑速度线优化**

- 二次规划QP
- 将平滑的非线性曲线与这些线段进行拟合
- 现成的工具：qpOASES

> 其他方法：**Lattice planning网格规划**

- SL轨迹和ST轨迹
- 两个轨迹合并处理，同时进行path和speed采样
- 设计cost
- 选择cost最小的轨迹，
- 条件检查和碰撞检查
- 检查失败则换第二条进行检查

缺点：**计算量大**，简化后的空间可行解不丰富，适用于物流小车

优化：

- S方向优化
  - 定速行驶：不需要采样，$v=vc,a=0$
  - 跟车行驶：需要对s和t同时采样，规定时间t跟在某个车后面，保证安全距离$v=v1,a=a1$
  - 停止：对车辆在哪里停下进行采样，s和t同时采样$a=0,v=0$

- L方向优化
  - 保证车辆以一个稳定的状态进入终点状态，比如和车道平齐

- 合成ST和SL坐标
  - 转化到cartesian坐标系
  - 生成XYTime一个三维轨迹
    - 两个坐标系中都有S
    - 找同一个S，对应的L和T

![image-20210903201613328](https://i.loli.net/2021/09/03/MHSWcz6tJBe84oi.png)

> Apollo如何求解规划问题

限制条件：

- soft constraints 和hard constraints
- 交通规则：hard constraints，用QP或者Hard code方式精细处理
- 决策：soft constraints，用DP的方式处理一些认为设置的软约束
- 最优轨迹：QP

换道：很多安全性

- 给出两种轨迹结果，让后续模块决定
- 换道是否安全
- 拿到的信息比planning丰富

Apollo EM Planner：期望最大化

- 先生成一条Optimal Path
- 在生成一条当前paht情况下的optimal speed
- 再将目前的speed返回去给path进行一次tuning
- 将tuning的paht返回给speed做优化
- 最后迭代得到最优解
- 贪心算法：local optimum

关键步骤

- 目标函数
  - 线性加权的cost
  - 其他
- 限制条件
  - 交通规则
  - 碰撞条件（无穷大）
  - 动态特性（车辆能力）
- 优化求解
  - 如何计算最优解（DP+QP）

DP：不要求问题是凸的，但是QP是一种凸优化

![image-20210903224756461](https://i.loli.net/2021/09/03/MCImHNzb3ke7ua2.png)

![image-20210903224821828](https://i.loli.net/2021/09/03/pzdFAik24XPgf1U.png)

![image-20210903224950287](https://i.loli.net/2021/09/03/6n7DfZCK1shWvwc.png)

# 控制

## 概述

![image-20210903225857783](https://i.loli.net/2021/09/03/OiEBFUAhrlVMcqg.png)

![image-20210903230227304](https://i.loli.net/2021/09/03/eGAnFVpDBgLy42f.png)

CANBUS：车辆底盘交互协议（车厂定）

- Chassis（底盘）
- 速度、四轮转速
- 健康状况
- 底盘报错
- 自动驾驶状态

仿真：

- 运动学模型
- 动力学模型

> 控制的任务

- 跟踪规划的轨迹信息
- 不同环境下的轨迹跟踪
  - 雨雪、陡坡、石头路
- 保证车辆可行性
- 保证车辆舒适性
- 实时性要求高（100hz）

> 重要性

控制模块： 让车辆在既定轨迹上平稳运行的学问

- 控制是对车辆油门、刹车、方向盘的精细控制
- 安全行驶的最后关卡
- 克服外界各种不确定性环境因素（风速、湿滑）

## 控制模块细分

- 预处理
- 控制器
- 后处理

> 预处理

- 数据清洗：不正常信号、planning异常值
- 合理性检查：定位信息、车辆底盘信号
- 紧急处理：突然出现障碍物
- 信号smooth：去除信号噪声、lag compensation

> 后处理

- saturation/limitation处理：执行器的固有缺陷补偿，上下限幅
- 信号smoothing：简单的平滑处理和异常检查

> 控制器设计

- 建模
- 系统参数辨识
- 控制观测器设计
- 参数fine tuning

控制系统作用：消除数学模型和物理模型差异

对于无人车：

- 提供稳定性
- 稳态误差尽可能小
- 动态误差

三个域：

- 时间域
  - 超调量
  - 超调时间
  - 稳态调整时间
  - 上升时间
- 频率域
  - 通过频率
  - 停止频率
  - 宽带
  - 截止频率
- 离散域（z变换）

傅里叶变换：时域到频域

![image-20210905121151552](https://i.loli.net/2021/09/05/cYC5klg7Gd6V2Ze.png)



![image-20210905121301446](https://i.loli.net/2021/09/05/7h2bHmYCaq6pXLB.png)

> PID

![image-20210905121948865](https://i.loli.net/2021/09/05/j5NXWIZ1AnEDPqg.png)

稳态误差是系统本身造成的



> 复杂控制器

动力学建模：

- 横向（重点、难点）
- 纵向

控制器设计：

- 纵向控制
- 横向控制（重点、难点）

![image-20210905122623332](https://i.loli.net/2021/09/05/LacQhre9YSbVtxT.png)

![image-20210905122744641](https://i.loli.net/2021/09/05/lAhoZJQOtafn6S3.png)

![image-20210905122815310](https://i.loli.net/2021/09/05/FphBCA4eaPsVz5K.png)





![image-20210905122921425](https://i.loli.net/2021/09/05/d5z3e6PhA7VgoyZ.png)



> 最优控制理论

![image-20210905123010842](https://i.loli.net/2021/09/05/IyizGdl1TqXU86t.png)



![image-20210905123115452](https://i.loli.net/2021/09/05/sovl6Xm4PaEr3LM.png)

![image-20210905123142750](https://i.loli.net/2021/09/05/13nE5uhNySsUYo7.png)

![image-20210905123317247](https://i.loli.net/2021/09/05/XjSs3rkKpOzQq5B.png)

![image-20210905123411872](https://i.loli.net/2021/09/05/MVFByJ4maAdo2XH.png)

![image-20210905123518177](https://i.loli.net/2021/09/05/zwkX1ORrHUi8fnt.png)

