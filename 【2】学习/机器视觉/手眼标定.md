[toc]

# 手眼标定

## 前言

机器人视觉应用中，手眼标定是一个非常基础且关键的问题。

对于一个带有视觉的机器人系统，**相机所获得的所有信息都是在相机坐标系下描述的**。要想让机器人利用视觉系统得到的信息，首先就是要确定相机坐标系与机器人之间的相对关系，这便是机器人**手眼标定**的研究内容。

简单来说手眼标定的目的就是获取**机器人坐标系和相机坐标系的关系**，最后将视觉识别的结果转移到机器人坐标系下。

## 相机安装方式

<center>
    <img src ="https://gitee.com/tianzhendong/img/raw/master//images/202202171422278.webp"
         width = "75%">
    <br>
    两种相机安装方式：（左）眼在手外，eye-to-hand；（右）眼在手上，eye-in-hand
</center>



如上图所示，在机器人系统中，相机的安装方式可以分为**两大类**：

- **眼在手外，eye-to-hand**：**机器人末端和标定板的位姿关系始终不变。**也即摄像头安装在手臂之外的部分，与机器人的基座（世界坐标系）相对固定，不随着机械臂的运动而运动；
- **眼在手上，eye-in-hand**：**标定板object和机器人底座base之间的相对位置保持不变。**也即摄像头安装在机械臂上，会随着机械臂的运动而发生运动。

## 坐标系和坐标转换

**坐标系：**

- 机器人基坐标系base
- 机器人末端坐标系end
- 相机坐标系cam
- 标定板坐标系object

**坐标转换矩阵：**

- $T^{Cam}_{Base}$：相机坐标系cam到机器人基坐标系base转换矩阵，**待求矩阵**
- $T^{Cam}_{Object}$：相机坐标系cam到标定板坐标系object的转换矩阵，**相机的外参**，通过相机标定获得
- $T^{Object}_{End}$：标定板object到机器人末端坐标系end的转换矩阵，**眼在手外（eye-to-hand）时，固定不变。**
- $T^{Cam}_{End}$：相机坐标系cam到机器人末端坐标系end的转换矩阵
- $T^{End}_{Base}$：机器人末端坐标系end到机器人基坐标系base的转换矩阵，**正运动学内容，DH参数**

## 手眼标定理论

**手眼标定eye in hand 和eye to hand 的区别主要是机器人那边，一个是end相对于base，另一个是base相对于end。千万注意。**

### eye in hand

**待求：相机cam在机器人末端坐标系end下的位姿**

- $T^{End}_{Base}$：机器人末端坐标系end到机器人基坐标系base的转换矩阵，**正运动学内容，DH参数**
- $T^{Cam}_{End}$：相机坐标系cam到机器人末端坐标系end的转换矩阵，**待求**
- $T^{Cam}_{Object}$：相机坐标系cam到标定板坐标系object的转换矩阵，**相机的外参**，通过相机标定获得

这种关系下，两次运动，机器人底座和标定板的关系始终不变。求解的量为相机和机器人末端坐标系的位姿关系。

![img](https://gitee.com/tianzhendong/img/raw/master//images/202202171500685.png)

变为$AX=XB$问题

###  eye to hand

**待求：相机坐标系cam和机器人基坐标系base之间的关系**

- $T^{End}_{Base}$：机器人末端坐标系end到机器人基坐标系base的转换矩阵，**正运动学内容，DH参数**
- $T^{Cam}_{Base}$：相机坐标系cam到机器人基坐标系base的转换矩阵，**待求**
- $T^{Cam}_{Object}$：相机坐标系cam到标定板坐标系object的转换矩阵，**相机的外参**，通过相机标定获得

这种关系下，两次运动，**机器人末端和标定板的位姿关系始终不变**。求解的量为相机和机器人底座坐标系之间的位姿关系。

![img](https://gitee.com/tianzhendong/img/raw/master//images/202202171500455.png)

变为$AX=XB$问题

## 相机标定

[相机标定（棋盘格标定法）MATLAB](https://blog.csdn.net/weixin_45622220/article/details/105365371?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164508563916781683943874%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=164508563916781683943874&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-105365371.pc_search_insert_es_download&utm_term=%E7%9B%B8%E6%9C%BA%E6%A0%87%E5%AE%9A&spm=1018.2226.3001.4187)

[相机标定的原理及实现,PYTHON](https://blog.csdn.net/weixin_43843780/article/details/89294131?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164508563916781683943874%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=164508563916781683943874&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-4-89294131.pc_search_insert_es_download&utm_term=%E7%9B%B8%E6%9C%BA%E6%A0%87%E5%AE%9A&spm=1018.2226.3001.4187)

### 前言

摄像机标定(Camera calibration)简单来说是**从世界坐标系转换为相机坐标系，再由相机坐标系转换为图像坐标系**的过程，也就是求最终的投影矩阵P的过程。

- 世界坐标系(world coordinate system)：用户定义的三维世界的坐标系，为了描述目标物在真实世界里的位置而被引入。单位为m。

- 相机坐标系(camera coordinate system)：在相机上建立的坐标系，为了从相机的角度描述物体位置而定义，作为沟通世界坐标系和图像/像素坐标系的中间一环。单位为m。

- 图像坐标系(image coordinate system)：为了描述成像过程中物体从相机坐标系到图像坐标系的投影透射关系而引入，方便进一步得到像素坐标系下的坐标。 单位为m。

一般来说，标定的过程分为两个部分：

- 第一步是从世界坐标系转换为相机坐标系，这一步是三维点到三维点的转换，包括$R$，$t$（相机外参）等参数；
- 第二部是从相机坐标系转为图像坐标系，这一步是三维点到二维点的转换，包括$K$（相机内参）等参数；

### 作用

1、相机在出厂之前都需要进行相机标定，用软件的方法校正生成的图像，避免拍摄出的图像产生桶形和枕形畸变

![在这里插入图片描述](https://gitee.com/tianzhendong/img/raw/master//images/202202171620663.png)

2、根据相机成像的几何模型，将世界坐标系中的3D物体映射到2D成像平面上
3、求解多个相机对之间的映射关系。

### 理论

对于一般相机而言，我们会用**小孔成像**模型来对其进行建模。

**在相机坐标系下**，空间中 3D 点 (X, Y, Z, 1)_c 与图像上对应 2D 点 (x y)_c 正好是满足如下关系：

![图片](https://gitee.com/tianzhendong/img/raw/master//images/202202171606237.webp)

其中的变换矩阵，就是我们说的**内参**矩阵，包含相机焦距等只与相机内部结构有关的参数。

**内参矩阵将摄像机坐标系转化为图片像素坐标系**



我们一般描述物体，都是在**世界坐标系**下的进行的，也即 (X, Y, Z, 1)_w ，而不是相机坐标系（因为我们无法知道相机坐标系的位置）。所以，我们需要先把物体坐标从世界坐标系变换到相机坐标系。

![图片](https://gitee.com/tianzhendong/img/raw/master//images/202202171607997.webp)

其中的转换矩阵为**外参矩阵，将世界坐标系转化为摄像机坐标系**



于是，我们就得到了完整的相机模型：

![图片](https://gitee.com/tianzhendong/img/raw/master//images/202202171607680.webp)

![在这里插入图片描述](https://gitee.com/tianzhendong/img/raw/master//images/202202171626823.png)



### 方法

相机标定的目的：获取摄像机的**内参和外参矩阵**（同时也会得到每一幅标定图像的选择和平移矩阵），内参和外参系数可以对之后相机拍摄的图像就进行矫正，得到畸变相对很小的图像。

---

相机标定的输入：标定图像上所有内角点的图像坐标，标定板图像上所有内角点的空间三维坐标（一般情况下假定图像位于Z=0平面上）。

相机标定的输出：摄像机的内参、外参系数。

---

这三个基础的问题就决定了使用Opencv实现**张正友法**标定相机的标定流程、标定结果评价以及使用标定结果矫正原始图像的完整流程：

- 准备标定图片
- 对每一张标定图片，提取角点信息
- 对每一张标定图片，进一步提取亚像素角点信息
- 在棋盘标定图上绘制找到的内角点（非必须，仅为了显示）
- 相机标定
- 对标定结果进行评价
- 查看标定效果——利用标定结果对棋盘图进行矫正

------------------------------------------------


## 手眼标定实践

机械臂已经能够按照位姿正常移动，机械臂能够正确读取末端（或者工具）末端的位姿，机械臂搭载相机成功，相机能够检测到物体，得到物体在相机中的位姿

- 将机械臂移动到某个位姿，记录机械臂在当前位姿时末端的姿态，一般的机械臂会在示教器上存在显示，否则的话你可以使用代码进行读取
- 使用机械臂上的相机，采集到待检测物体在相机中的位姿，并记录。这时你会有一对位姿了，一对位姿包括：机械臂的位姿X + 机械臂在位姿X时相机采集到物体在相机中的位姿
- 重复1、2步骤，直到你采了10组以上（不同算法有不同的要求，但有10组数据是最基本的）
- 传入代码中进行计算，就能标定出手眼矩阵了



## 参考文献

[3D 视觉之手眼标定](https://mp.weixin.qq.com/s?__biz=MzA5MDE2MjQ0OQ==&mid=2652786821&idx=1&sn=297af3939075dbc926e6d785911104e9&chksm=8be524fbbc92aded68bacb1766df0a17127a96f22e1e39199f554b51511a1a9dae4a639810ef#rd)

[机器人手眼标定Ax=xB（eye to hand和eye in hand）及平面九点法标定](https://blog.csdn.net/yaked/article/details/77161160?spm=1001.2101.3001.6650.5&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7EHighlightScore-5.queryctrv2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7EHighlightScore-5.queryctrv2&utm_relevant_index=9)

